<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RetroReact: Hobbyist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/seven-segment" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
        });

        window.submitScoreToCloud = async (name, score, time, mode) => {
            if (!currentUser) return;
            try {
                const scoresRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
                await addDoc(scoresRef, {
                    name: name || "UNKNOWN",
                    score: score,
                    time: time,
                    mode: mode,
                    timestamp: Date.now(),
                    userId: currentUser.uid
                });
            } catch (e) { console.error(e); }
        };

        window.fetchGlobalLeaderboard = async (currentMode) => {
            if (!currentUser) return [];
            try {
                const scoresRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
                const snapshot = await getDocs(scoresRef);
                let scores = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.mode === currentMode) scores.push({ ...data, id: doc.id });
                });
                scores.sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return a.time - b.time;
                });
                return scores.slice(0, 10);
            } catch (e) { return []; }
        };

        window.getCurrentUserId = () => currentUser ? currentUser.uid : null;
    </script>

    <style>
        :root {
            /* RADIO SHACK / HOBBYIST PALETTE */
            --bg-mat: #1a1a1a;
            /* Dark Grey Tabletop */
            --box-plastic: #2a2a2a;
            /* Standard Project Box Grey */
            --box-highlight: #3a3a3a;
            --box-shadow: #111;

            /* Accents */
            --accent-blue: #0066cc;
            /* Science Fair Blue */
            --accent-yellow: #ffcc00;
            /* Wiring Yellow */
            --accent-silver: #c0c0c0;
            /* Potentiometer Silver */

            /* Components */
            --led-off: #4d0000;
            --led-on: #ff3333;
            --led-dim: #990000;

            /* Text */
            --text-main: #e0e0e0;
            --text-dim: #aaa;
            --text-label: #fff;
        }

        body {
            /* Standard computer font for that "Manual" feel, or VCR OSD */
            font-family: 'Share Tech Mono', monospace;
            background-color: var(--bg-mat);
            /* Authentic "Particle Board" Desk Texture */
            background-image:
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.15'/%3E%3C/svg%3E");
            color: var(--text-main);
            overflow: hidden;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            font-size: 1.2rem;
        }

        /* --- THE PIPE (BREADBOARD AREA) --- */
        .pipe-assembly {
            position: relative;
            width: 180px;
            height: 75vh;
            display: flex;
            flex-direction: column;
            filter: drop-shadow(5px 5px 15px rgba(0, 0, 0, 0.6));
        }

        .pipe-body {
            flex: 1;
            /* Printed Circuit Board / Breadboard Strip look */
            background: #252525;
            border: 2px solid #444;
            position: relative;
            display: flex;
            flex-direction: column-reverse;
            justify-content: space-evenly;
            padding: 30px 10px;
            border-radius: 4px;
            /* Vertical pinstripe to look like a breadboard column */
            background-image: linear-gradient(90deg, transparent 48%, rgba(255, 255, 255, 0.05) 50%, transparent 52%);
            z-index: 2;
        }

        /* --- 5MM LEDS --- */
        .led-slot {
            width: 32px;
            height: 32px;
            /* Square slot for round bulb */
            margin: 0 auto;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* The Printed socket marking */
        .led-slot::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border: 1px dashed #555;
            border-radius: 50%;
            opacity: 0.3;
        }

        .led-bulb {
            width: 20px;
            height: 20px;
            background-color: var(--led-off);
            border-radius: 50%;
            /* Round 5mm bulb */
            /* Plastic Dome shader */
            background-image: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.4) 0%, transparent 40%);
            border: 1px solid rgba(0, 0, 0, 0.5);
            box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            transition: all 0.05s;
        }

        .led-slot.active .led-bulb {
            background-color: var(--led-on);
            /* Active Diffused Glow */
            box-shadow:
                0 0 10px var(--led-on),
                inset 2px 2px 5px rgba(255, 255, 255, 0.5);
            border-color: #ff8888;
            transform: scale(1.05);
        }

        .led-slot.completed .led-bulb {
            background-color: var(--led-dim);
            box-shadow: none;
            opacity: 0.7;
        }

        /* --- COMPONENT SWITCH --- */
        .switch-assembly {
            position: absolute;
            bottom: 15%;
            right: -45px;
            width: 40px;
            height: 50px;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #111;
            border-radius: 4px;
            border: 1px solid #444;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        }

        .switch-plunger {
            width: 12px;
            height: 24px;
            background: #cc0000;
            /* Standard red switch */
            border-radius: 2px;
            box-shadow: inset 1px 1px 2px rgba(255, 255, 255, 0.3);
            position: relative;
            cursor: pointer;
            transition: transform 0.05s;
        }

        .switch-assembly.pressed .switch-plunger {
            transform: scale(0.9);
            background: #aa0000;
        }

        .switch-hitbox {
            position: absolute;
            top: -30px;
            bottom: -30px;
            left: -30px;
            right: -30px;
            cursor: pointer;
            z-index: 20;
        }

        /* --- PRINTED LABELS (NOT DYMO) --- */
        .dymo-label {
            background: transparent;
            color: var(--text-label);
            font-family: 'Helvetica', 'Arial', sans-serif;
            /* Standard silk-screen print */
            font-weight: bold;
            font-size: 0.7rem;
            padding: 0;
            border: none;
            box-shadow: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            text-shadow: none;
            width: 100%;
            text-align: center;
            opacity: 0.8;
            margin-bottom: 2px;
        }

        /* --- 7-SEGMENT DISPLAY COMPONENTS --- */
        .lcd-module {
            background: #151515;
            /* Dark acrylic window */
            border: 2px solid #555;
            /* Bezel */
            border-radius: 4px;
            width: 8rem;
            height: 3rem;
            padding: 0 4px;
            font-family: 'Seven Segment', monospace;
            color: var(--led-on);
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
            /* Milder glow */
            box-shadow: inset 0 0 10px #000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 2rem;
            font-weight: normal;
            transform: none;
            /* Remove skew for cheaper look */
        }

        /* Only skew the main title for style */

        /* --- BUTTONS: TACTILE SWITCHES --- */
        .retro-btn {
            background: #333;
            border: 2px solid #555;
            border-bottom-width: 4px;
            /* Physical height */
            color: #ccc;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Helvetica', 'Arial', sans-serif;
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.05s;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .retro-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
            background: #222;
            color: #fff;
        }

        .retro-btn-red {
            background: #cc0000;
            border-color: #ff3333 #990000 #990000 #ff3333;
            color: white;
        }

        .retro-btn-red:active {
            background: #aa0000;
        }

        /* --- PROJECT BOX CASING --- */
        .device-casing {
            background-color: var(--box-plastic);
            /* ABS Plastic Texture */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            border: none;
            border-radius: 12px;
            /* Simple physical drop shadow, no glow */
            box-shadow:
                0 15px 30px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            padding: 2rem;
            color: #eee;
            position: relative;
        }

        /* The Printed Front Panel Sticker */
        .device-casing::after {
            content: '';
            position: absolute;
            top: 15px;
            bottom: 15px;
            left: 15px;
            right: 15px;
            border: 2px solid var(--accent-blue);
            /* Science Fair Accent */
            border-radius: 8px;
            pointer-events: none;
            opacity: 0.5;
        }

        .text-label {
            color: var(--text-dim);
            font-family: 'Helvetica', 'Arial', sans-serif;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Tiny buttons */
        .control-btn {
            background: #ddd;
            /* Light grey plastic */
            border: 1px solid #999;
            border-bottom: 3px solid #666;
            color: #222;
            font-weight: bold;
            font-size: 0.65rem;
            padding: 6px 4px;
            border-radius: 2px;
            text-transform: uppercase;
            font-family: 'Helvetica', 'Arial', sans-serif;
            cursor: pointer;
        }

        .control-btn:active {
            border-bottom-width: 1px;
            transform: translateY(2px);
            background: #ccc;
        }

        .control-btn-red {
            background: #ff3333;
            border-color: #cc0000;
            border-bottom-color: #990000;
            color: white;
        }

        /* --- HELPERS --- */
        #orientation-warning {
            display: none;
            position: fixed;
            inset: 0;
            background: #222;
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            color: white;
        }

        @media (max-height: 600px) and (orientation: landscape) {

            #game-ui,
            #intro-screen {
                display: none !important;
            }

            #orientation-warning {
                display: flex;
            }
        }

        .modal-card {
            background: #333;
            border: 2px solid #666;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
            color: #eee;
            border-radius: 4px;
        }

        .stats-container {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            margin-right: 2rem;
            align-items: flex-end;
            width: 9rem;
        }

        .stat-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        /* POWER CONNECTOR */
        .power-connector {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 14px;
            height: 25px;
            background: #1a1a1a;
            border-radius: 2px;
            border: 1px solid #333;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5);
            z-index: 1;
        }

        .power-wire {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100vh;
            background: #111;
            box-shadow: 1px 0 2px rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body class="h-screen w-full flex flex-col items-center justify-center relative overflow-hidden">

    <!-- Orientation Warning -->
    <div id="orientation-warning">
        <h2 class="text-xl font-bold mb-2">ROTATE DEVICE</h2>
        <p>Vertical alignment required</p>
    </div>

    <!-- Intro Screen -->
    <div id="intro-screen"
        class="absolute inset-0 z-50 flex flex-col items-center justify-center transition-all duration-500 bg-transparent">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/80 -z-10"></div>

        <!-- Main Device Card -->
        <div class="device-casing flex flex-col items-center max-w-sm w-full mx-4">

            <div class="text-5xl font-bold mb-6 tracking-tighter text-center"
                style="color: #ccc; font-family: 'Share Tech Mono', monospace; letter-spacing: -2px; text-shadow: 2px 2px 0 #111;">
                RETRO<span class="text-[#ff3333]">REACT</span>
            </div>

            <div class="w-full h-1 bg-[#111] border-b border-[#444] mb-8"></div>

            <div class="w-full mb-6">
                <div class="text-xs font-bold text-label mb-1 tracking-widest pl-1">ID_CALLSIGN</div>
                <input type="text" id="player-name"
                    class="w-full bg-[#151515] border-2 border-[#555] p-3 text-center uppercase text-[#ff3333] text-2xl shadow-inner focus:outline-none focus:border-[#777]"
                    style="font-family: 'Seven Segment', monospace; letter-spacing: 3px; caret-color: red;"
                    placeholder="PLAYER 1" maxlength="12">
            </div>

            <div class="w-full mb-8">
                <div class="text-xs font-bold text-label mb-1 tracking-widest pl-1">SEQUENCE_MODE</div>
                <div class="flex gap-4 p-1 rounded">
                    <button id="mode-normal" class="flex-1 retro-btn text-sm"
                        onclick="setMode('normal')">NORMAL</button>
                    <button id="mode-endless" class="flex-1 retro-btn text-sm" style="opacity: 0.5;"
                        onclick="setMode('endless')">ENDLESS</button>
                </div>
            </div>

            <button id="start-btn" class="w-full retro-btn retro-btn-red text-3xl font-bold p-4 tracking-widest mt-2">
                INITIATE
            </button>
        </div>

        <button id="leaderboard-btn"
            class="mt-8 text-white text-xs uppercase tracking-widest hover:text-gray-300 transition-colors z-20">
            // VIEW_LOGS
        </button>
    </div>

    <!-- Gameplay UI -->
    <div id="game-ui"
        class="relative z-10 w-full max-w-lg h-full flex flex-col items-center justify-center p-4 opacity-0 transition-opacity duration-500 pointer-events-none">

        <div class="flex flex-row items-center justify-center mt-6">
            <!-- Left Side: Stats & Controls -->
            <div class="stats-container pointer-events-auto">
                <div class="stat-group">
                    <div class="dymo-label mb-1">LEVEL</div>
                    <div class="lcd-module text-3xl">
                        <span id="level-num">00</span><span id="level-max" class="text-sm opacity-50 ml-1">10</span>
                    </div>
                </div>

                <div class="stat-group">
                    <div class="dymo-label mb-1">TIMER</div>
                    <div id="timer-display" class="lcd-module text-xl">00:00:00</div>
                </div>
                <div class="stat-group">
                    <div class="dymo-label mb-1">BEST</div>
                    <div id="best-time-display" class="lcd-module text-sm opacity-70">--:--:--</div>
                </div>

                <!-- Controls Cluster -->
                <div class="w-full pt-4 border-t border-[#444] mt-2 flex flex-col gap-3">
                    <div class="flex gap-2">
                        <button id="leaderboard-btn-game" class="control-btn" style="flex:1;">LOGS</button>
                    </div>
                    <div class="flex gap-2">
                        <button id="sound-btn" class="control-btn" style="flex: 1;">SND: OFF</button>
                        <button id="restart-game-btn" class="control-btn control-btn-red"
                            style="flex: 1;">ABORT</button>
                    </div>
                </div>
            </div>

            <!-- Center: The Pipe Artifact -->
            <div class="pipe-assembly">
                <div class="pipe-body" id="tube-grid">
                    <!-- LEDs injected here -->
                </div>
                <!-- Power Cable -->
                <div class="power-connector">
                    <div class="power-wire"></div>
                </div>

                <!-- The Button on the Side -->
                <div class="switch-assembly" id="switch-mech">
                    <div class="switch-hitbox pointer-events-auto" id="trigger-btn"></div>
                    <div class="switch-housing"></div>
                    <div class="switch-plunger"></div>
                </div>
            </div>

            <!-- Right Side: Spacer -->
            <div class="ml-8 w-8"></div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal"
        class="hidden fixed inset-0 z-[70] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm pointer-events-auto">
        <div class="modal-card w-full max-w-md p-6 flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-2">
                <div class="dymo-label">LOGBOOK</div>
                <button id="close-leaderboard" class="font-bold text-red-500">X</button>
            </div>
            <div id="leaderboard-list"
                class="space-y-2 text-sm overflow-y-auto flex-1 font-mono bg-black text-green-500 border border-gray-600 p-4 shadow-inner h-64">
            </div>
        </div>
    </div>

    <!-- Result Overlay -->
    <div id="result-modal"
        class="hidden absolute inset-0 z-[60] flex flex-col items-center justify-center p-6 bg-black/60 backdrop-blur-md pointer-events-auto transition-opacity duration-300">
        <div
            class="bg-[#333] p-6 border-4 border-[#111] shadow-2xl flex flex-col items-center w-full max-w-xs rotate-1 ring-4 ring-black/50">
            <h2 id="result-title" class="text-4xl font-black text-white mb-2 tracking-widest uppercase">DONE</h2>
            <div id="result-subtitle" class="dymo-label mb-6 bg-black text-gray-400 border-none shadow-none">SEQUENCE
                ENDED</div>
            <div class="w-full mb-1 text-xs text-gray-400 font-bold ml-1">FINAL STATS</div>
            <div
                class="bg-[#9ea792] border-4 border-[#222] p-3 w-full mb-4 font-mono text-center text-3xl text-[#222] shadow-inner rounded tracking-widest font-black">
                <div id="final-time">00:00:00</div>
            </div>
            <div class="flex justify-between w-full px-2 text-xs font-bold text-gray-500 mb-6">
                <span>ERRORS</span>
                <span id="mistake-count" class="text-red-500 text-lg">0</span>
            </div>
            <button id="restart-btn"
                class="w-full bg-[#cc3333] text-white font-bold p-3 border-b-4 border-[#990000] active:border-b-0 active:translate-y-1 transition-all shadow-lg uppercase tracking-widest">
                RESET SYSTEM
            </button>
        </div>
    </div>

    <script>
        /* --- CONFIG --- */
        const LEVELS = 10;
        const COLORS = Array(12).fill('#ff1a1a');

        /* --- STATE --- */
        const state = {
            gameMode: 'normal',
            playing: false,
            level: 0,
            hasStartedAscent: false,
            lightOn: false,
            timerId: null,
            stopwatchId: null,
            startTime: 0,
            mistakes: 0,
            bestTime: null,
            muted: true,
            playerName: "",
            inputLocked: false
        };

        const ui = {
            tube: document.getElementById('tube-grid'),
            level: document.getElementById('level-num'),
            levelMax: document.getElementById('level-max'),
            timer: document.getElementById('timer-display'),
            bestTime: document.getElementById('best-time-display'),
            intro: document.getElementById('intro-screen'),
            game: document.getElementById('game-ui'),
            resultModal: document.getElementById('result-modal'),
            leaderboardModal: document.getElementById('leaderboard-modal'),
            leaderboardList: document.getElementById('leaderboard-list'),
            finalTime: document.getElementById('final-time'),
            mistakeCount: document.getElementById('mistake-count'),
            soundBtn: document.getElementById('sound-btn'),
            restartGameBtn: document.getElementById('restart-game-btn'),
            leaderboardBtn: document.getElementById('leaderboard-btn'),
            leaderboardBtnGame: document.getElementById('leaderboard-btn-game'),
            nameInput: document.getElementById('player-name'),
            switchMech: document.getElementById('switch-mech')
        };

        /* --- AUDIO --- */
        class AudioEngine {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.master = this.ctx.createGain();
                this.master.gain.value = 0.4;
                this.master.connect(this.ctx.destination);
            }
            playClick() {
                // Short, sharp high pitch "tick"
                if (state.muted || this.ctx.state === 'suspended') { if (!state.muted) this.ctx.resume(); return; }
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';
                const now = this.ctx.currentTime;
                // High blip
                osc.frequency.setValueAtTime(2000, now);
                osc.frequency.exponentialRampToValueAtTime(1000, now + 0.02);
                gain.gain.setValueAtTime(0.15, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.02);
                osc.connect(gain);
                gain.connect(this.master);
                osc.start();
                osc.stop(now + 0.03);
            }
            playHit() {
                // Success: Fixed high-pitch piezo beep (authentic 80s kit)
                if (state.muted || this.ctx.state === 'suspended') { if (!state.muted) this.ctx.resume(); return; }
                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';

                // Fixed frequency (880Hz)
                osc.frequency.setValueAtTime(880, now);

                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.1, now + 0.08);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);

                osc.connect(gain);
                gain.connect(this.master);
                osc.start();
                osc.stop(now + 0.1);
            }
            playFail() {
                if (state.muted || this.ctx.state === 'suspended') { if (!state.muted) this.ctx.resume(); return; }
                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.connect(gain);
                gain.connect(this.master);
                osc.start();
                osc.stop(now + 0.4);
            }
            playWin() {
                if (state.muted || this.ctx.state === 'suspended') { if (!state.muted) this.ctx.resume(); return; }
                [523, 659, 783, 1046].forEach((f, i) => {
                    setTimeout(() => {
                        const now = this.ctx.currentTime;
                        const osc = this.ctx.createOscillator();
                        const gain = this.ctx.createGain();
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(f, now);
                        gain.gain.setValueAtTime(0.1, now);
                        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        osc.connect(gain);
                        gain.connect(this.master);
                        osc.start();
                        osc.stop(now + 0.1);
                    }, i * 120);
                });
            }
        }

        let audio;

        /* --- GAME LOGIC --- */
        function init() {
            loadData();
            if (!state.playerName) state.playerName = generateCallsign();
            ui.nameInput.value = state.playerName;

            ui.intro.style.display = 'flex';
            ui.game.style.opacity = '0';
            ui.game.style.pointerEvents = 'none';
            ui.soundBtn.innerText = state.muted ? 'SND: OFF' : 'SND: ON';
            renderGrid();
        }

        function setMode(mode) {
            state.gameMode = mode;
            document.getElementById('mode-normal').style.opacity = mode === 'normal' ? '1' : '0.5';
            document.getElementById('mode-endless').style.opacity = mode === 'endless' ? '1' : '0.5';
        }

        function startGame() {
            if (!audio) audio = new AudioEngine();
            const name = ui.nameInput.value.trim() || "PLAYER 1";
            state.playerName = validateAndSanitizeName(name);
            saveData();

            state.playing = true;
            state.level = 0;
            state.mistakes = 0;
            state.hasStartedAscent = false;
            state.lightOn = false;
            state.inputLocked = false;

            ui.intro.style.display = 'none';
            ui.resultModal.style.display = 'none';

            ui.game.style.display = 'flex';
            setTimeout(() => {
                ui.game.style.opacity = '1';
                ui.game.style.pointerEvents = 'auto';
            }, 100);

            ui.mistakeCount.innerText = "0";
            ui.timer.innerText = "00:00:00";

            setTimeout(startLevel, 1000);
        }

        function getWeightedRandomDelay() {
            const roll = Math.random();
            if (roll < 0.15) return 50;
            if (roll < 0.50) return 200 + Math.random() * 200;
            if (roll < 0.80) return 500 + Math.random() * 500;
            if (roll < 0.95) return 1500 + Math.random() * 1000;
            return 2500 + Math.random() * 1000;
        }

        function startLevel() {
            clearTimeout(state.timerId);
            state.lightOn = false;
            state.inputLocked = false;

            const displayLevel = state.level + 1;
            ui.level.innerText = displayLevel.toString().padStart(2, '0');

            renderGrid();

            const delay = state.level === 0 ? 500 : getWeightedRandomDelay();

            state.timerId = setTimeout(() => {
                runCycle();
            }, delay);
        }

        function runCycle() {
            if (!state.playing) return;

            // --- INACTION CHECK ---
            if (state.lightOn) {
                if (!state.hasStartedAscent) {
                    state.lightOn = false;
                    renderVisuals();
                    state.timerId = setTimeout(runCycle, 600);
                    return;
                } else {
                    handleFail();
                    return;
                }
            }

            // TOGGLE STATE
            state.lightOn = !state.lightOn;
            renderVisuals();

            // --- DURATION LOGIC ---
            let duration = 600;

            if (state.level === 0) {
                duration = 600;
            } else {
                if (state.lightOn) {
                    duration = Math.max(150, 500 - (state.level * 30));
                    duration = duration * (0.9 + Math.random() * 0.2);
                } else {
                    const roll = Math.random();
                    if (roll < 0.20) duration = 50 + Math.random() * 100;
                    else if (roll < 0.60) duration = 150 + Math.random() * 250;
                    else duration = 400 + Math.random() * 600;
                }
            }

            state.timerId = setTimeout(runCycle, duration);
        }

        function renderVisuals() {
            if (state.lightOn && audio) audio.playClick();
            renderGrid();
        }

        function renderGrid() {
            const slots = state.gameMode === 'normal' ? LEVELS : 10;
            ui.tube.innerHTML = '';

            for (let i = 0; i < slots; i++) {
                const div = document.createElement('div');
                div.className = 'led-slot';
                div.id = `slot-${i}`;

                const bulb = document.createElement('div');
                bulb.className = 'led-bulb';
                div.appendChild(bulb);

                const levelInSet = state.level % slots;
                if (i < levelInSet) {
                    div.classList.add('completed');
                } else if (i === levelInSet) {
                    if (state.lightOn) div.classList.add('active');
                }

                ui.tube.appendChild(div);
            }
        }

        function handleInput() {
            if (!state.playing) return;
            if (state.inputLocked) return;

            ui.switchMech.classList.add('pressed');
            setTimeout(() => ui.switchMech.classList.remove('pressed'), 100);

            if (state.lightOn) {
                // SUCCESS
                if (!state.hasStartedAscent) {
                    state.hasStartedAscent = true;
                    startStopwatch();
                }
                if (navigator.vibrate) navigator.vibrate(20);
                audio.playHit();
                state.level++;

                if (state.gameMode === 'normal' && state.level >= LEVELS) winGame();
                else startLevel();
            } else {
                // FAIL
                if (!state.hasStartedAscent) {
                    audio.playFail();
                    return;
                }
                handleFail();
            }
        }

        function handleFail() {
            if (!state.playing) return;

            state.inputLocked = true;

            if (navigator.vibrate) navigator.vibrate(100);
            audio.playFail();
            state.mistakes++;

            if (state.level > 0) state.level--;

            if (state.level === 0 && state.hasStartedAscent) {
                renderGrid();
                setTimeout(() => { gameOver(); }, 300);
                return;
            }

            renderGrid();
            clearTimeout(state.timerId);
            state.lightOn = false;
            renderVisuals();

            setTimeout(startLevel, 500);
        }

        function formatTime(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            const centis = Math.floor((ms % 1000) / 10);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}:${centis.toString().padStart(2, '0')}`;
        }
        function startStopwatch() { state.startTime = Date.now(); updateStopwatch(); }
        function updateStopwatch() {
            if (!state.playing) return;
            ui.timer.innerText = formatTime(Date.now() - state.startTime);
            state.stopwatchId = requestAnimationFrame(updateStopwatch);
        }
        function winGame() { endGame("CLEARED", "MISSION COMPLETE", true); }
        function gameOver() { endGame("FAILURE", "SYSTEM HALT", false); }
        function endGame(title, subtitle, isWin) {
            state.playing = false;
            cancelAnimationFrame(state.stopwatchId);
            clearTimeout(state.timerId);
            const finalTime = Date.now() - state.startTime;

            if (isWin) audio.playWin();
            else audio.playFail();

            if (isWin && (!state.bestTime || finalTime < state.bestTime)) {
                state.bestTime = finalTime;
                saveData();
                ui.bestTime.innerText = `PB: ${formatTime(finalTime)}`;
            }

            if (window.submitScoreToCloud) {
                window.submitScoreToCloud(state.playerName, state.level, finalTime, state.gameMode);
            }

            document.getElementById('result-title').innerText = title;
            document.getElementById('result-subtitle').innerText = subtitle;
            ui.finalTime.innerText = formatTime(finalTime);
            ui.mistakeCount.innerText = state.mistakes;

            ui.resultModal.style.display = 'flex';
            ui.resultModal.style.pointerEvents = 'auto';
        }

        function saveData() {
            if (state.bestTime) localStorage.setItem('reflex_best_time', state.bestTime);
            localStorage.setItem('reflex_muted', state.muted);
            localStorage.setItem('reflex_player_name', state.playerName);
        }
        function loadData() {
            const t = localStorage.getItem('reflex_best_time');
            if (t) { state.bestTime = parseInt(t); ui.bestTime.innerText = `PB: ${formatTime(state.bestTime)}`; }
            const m = localStorage.getItem('reflex_muted');
            if (m === 'true') { state.muted = true; applyMute(); }
            const n = localStorage.getItem('reflex_player_name');
            if (n) { state.playerName = n; }
        }
        function toggleSound() { state.muted = !state.muted; applyMute(); saveData(); }
        function applyMute() {
            ui.soundBtn.innerText = state.muted ? 'SND: OFF' : 'SND: ON';
        }

        async function displayGlobalLeaderboard() {
            ui.leaderboardModal.style.display = 'flex';
            ui.leaderboardList.innerHTML = '<div class="text-center p-4">LOADING DATA...</div>';

            let scores = [];
            if (window.fetchGlobalLeaderboard) scores = await window.fetchGlobalLeaderboard(state.gameMode);

            const myId = window.getCurrentUserId ? window.getCurrentUserId() : "me";

            if (scores.length === 0) {
                ui.leaderboardList.innerHTML = '<div class="text-center p-4">NO RECORDS</div>';
                return;
            }

            let html = '';
            scores.forEach((entry, index) => {
                const rank = index + 1;
                const isUser = entry.userId === myId;
                const highlight = isUser ? "font-bold bg-yellow-100 text-black" : "text-green-500";
                const scoreDisplay = state.gameMode === 'endless' ? `LVL ${entry.score}` : formatTime(entry.time);

                html += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; padding: 4px;" class="${highlight}">
                        <span>${rank}. ${entry.name}</span>
                        <span>${scoreDisplay}</span>
                    </div>
                `;
            });
            ui.leaderboardList.innerHTML = html;
        }

        function generateCallsign() { return `UNIT-${Math.floor(Math.random() * 9000) + 1000}`; }

        function validateAndSanitizeName(name) {
            let clean = name.toUpperCase().replace(/[^A-Z0-9-]/g, '');
            if (clean.length < 3 || clean.length > 12) return generateCallsign();
            const BAD_WORDS = ["BS", "CRAP", "DAMN", "HELL", "SUCK", "WTF", "XXX", "SEX", "DICK", "COCK", "PUSSY", "FUCK", "SHIT", "ASS", "CUNT", "BITCH", "NIGGA", "NIGGER", "FAG", "DYKE"];
            for (let word of BAD_WORDS) if (clean.includes(word)) return generateCallsign();
            return clean;
        }

        ui.leaderboardBtn.addEventListener('click', displayGlobalLeaderboard);
        ui.leaderboardBtnGame.addEventListener('click', displayGlobalLeaderboard);
        ui.soundBtn.addEventListener('click', toggleSound);
        document.getElementById('close-leaderboard').addEventListener('click', () => { ui.leaderboardModal.style.display = 'none' });
        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('restart-btn').addEventListener('click', startGame);
        ui.restartGameBtn.addEventListener('click', startGame);

        const btn = document.getElementById('trigger-btn');
        btn.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            handleInput();
        });

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'Enter') {
                if (ui.intro.style.display !== 'none') startGame();
                else if (ui.resultModal.style.display === 'flex') startGame();
                else if (ui.leaderboardModal.style.display === 'flex') ui.leaderboardModal.style.display = 'none';
                else { handleInput(); }
            }
        });

        // Initial Grid
        renderGrid();
        init();
    </script>
</body>

</html>